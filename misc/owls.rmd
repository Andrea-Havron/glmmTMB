---
title: "Compare zero-inflated mixed models across R packages"
author: "Mollie Brooks and Ben Bolker"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```
In this appendix, we analyze counts of begging behavior by owl nestlings. This example previously appeared in Zuur et al. (2009) and Bolker et al. (2012) and was origianally published by Roulin and Bersier (2007). More description...

#Preliminaries

##Load packages
```{r libs,warning=FALSE, message=FALSE}
library(glmmTMB)
library(glmmADMB)
library(MCMCglmm)
library(brms)
library(broom)#for tidy
library(plyr)
library(ggplot2); theme_set(theme_bw())
library(ggstance)#for position_dodgev
```

## Data organization and helper functions

```{r data}
data(Owls)
Owls = rename(Owls, c(SiblingNegotiation="NCalls"))
Owls = transform(Owls, ArrivalTime=scale(ArrivalTime, center=TRUE, scale=FALSE))
```

```{r helper}
## time 
tfun <- function(...) unname(system.time(capture.output(...))["elapsed"])
```

#Fitting the same model in 4 packages

##glmmTMB
```{r tmbfit}
form <- NCalls~(FoodTreatment + ArrivalTime) * SexParent + 
	offset(logBroodSize) + (1|Nest)
time.tmb = tfun(m1.tmb <<- glmmTMB(form,
                                  ziformula=~1, data = Owls, family="poisson"))
```

##glmmADMB
```{r admbfit}
time.admb = tfun(m1.admb <<- glmmadmb(form,
                 zeroInflation=TRUE, data = Owls, family="poisson"))
```

##MCMCglmm
Code for this example was copied from Bolker et al. (2012) and a description appears in that text.
```{r mcmcglmmfit}
offvec = c(1,1,2,rep(1,5))
fixef2 = NCalls~trait-1+ ## intercept terms for both count and binary terms
   at.level(trait,1):logBroodSize+
   at.level(trait,1):((FoodTreatment+ArrivalTime)*SexParent)
prior_overdisp  = list(R=list(V=diag(c(1,1)),nu=0.002,fix=2),   
                       G=list(list(V=diag(c(1,1e-6)),nu=0.002,fix=2)))

 prior_overdisp_broodoff = c(prior_overdisp,
                              list(B=list(mu=c(0,1)[offvec],
                                V=diag(c(1e8,1e-6)[offvec]))))

time.mcmc=tfun(m1.mcmc <<- MCMCglmm(fixef2,
                                   rcov=~idh(trait):units,
                                   random=~idh(trait):Nest,
                                   prior=prior_overdisp_broodoff,
                                   data=Owls,
                                   family="zipoisson",
                                   verbose=FALSE))
```

##brms

```{r brmsfit}
time.brms = tfun(m1.brms <<- brm(form, data = Owls,
                                family="zero_inflated_poisson",
                                save_dso=TRUE))
```

```{r brmsfit2}
time.brms2 = tfun(m1.brms2 <<- update(m1.brms))
```

#Comparing the results

## Timings

```{r times}
sort(c(TMB=time.tmb,ADMB=time.admb,MCMCglmm=time.mcmc,brms=time.brms,
  brms2=time.brms2))
```
(Time is recorded in seconds.)

`glmmTMB` fit the model in less than 5 seconds. Other methods were slower, but `MCMCglmm` was in the same order of magnitude (`brms` and `brms2` are times including and excluding compilation time, respectively).


## Estimated fixed-effect coefficients

```{r coefplot, echo=FALSE, fig.width=7}
abbfun <- function(x) {
   gsub("(Sol\\.)*(trait|at.level\\(trait, 1\\):)*","",
        gsub("FoodTreatment","FT",x))
 }

coefs=list("glmmTMB"=tidy(summary(m1.tmb)$coefficients$cond),
           "glmmADMB"=tidy(summary(m1.admb)$coefficients), 
           "MCMCglmm"=tidy(summary(m1.mcmc)$solutions), 
           "brms"=tidy(summary(m1.brms)$fixed))
           
#coefs$MCMCglmm$.rownames=abbfun(coefs$MCMCglmm$.rownames)
coefs$MCMCglmm=coefs$MCMCglmm[-c(2,3),]

colnames(coefs$MCMCglmm)[2:4]=c("Estimate", "LCI","UCI") 
colnames(coefs$brms)[c(2,4,5)]=c("Estimate", "LCI","UCI") 
coefs$glmmTMB=transform(coefs$glmmTMB, 
                        LCI=Estimate-2*Std..Error,
                        UCI=Estimate+2*Std..Error)
coefs$glmmADMB=transform(coefs$glmmADMB, 
                        LCI=Estimate-2*Std..Error,
                        UCI=Estimate+2*Std..Error)

coefs2=ldply(coefs, function(x){
    x[,".rownames"]=abbfun( x[,".rownames"])
    x[1,".rownames"]="Intercept"
    x[,c(".rownames", "Estimate", "LCI", "UCI")]
})
ggplot(coefs2, aes(color=.id,y=.rownames, x=Estimate))+
    labs(x="Regression estimate",y="")+
    geom_pointrangeh(aes(xmax=UCI, xmin=LCI),
                     position = position_dodgev(height = 0.5))+
    theme(legend.title = element_blank())+theme_bw()
```

Because we ran `brms` with flat priors, the estimates are very close to the maximum likelihood estimates of `glmmTMB`. Maximum likelihood estimates from `glmmTMB` and `glmmADMB` differ slightly because `glmmADMB` uses some numerical tricks to increase robustness and these change the objective function by a small amount.

#References

Bolker, B. M., Gardner, B., Maunder, M., Berg, C. W., Brooks, M., Comita, L., Crone, E., Cubaynes, S., Davies, T., de Valpine, P., Ford, J., Gimenez, O., Kéry, M., Kim, E. J., Lennert-Cody, C., Magnusson, A., Martell, S., Nash, J., Nielsen, A., Regetz, J., Skaug, H. and Zipkin, E. (2013), Strategies for fitting nonlinear ecological models in R, AD Model Builder, and BUGS. Methods Ecol Evol, 4: 501–512. doi:10.1111/2041-210X.12044

Roulin, A. and L. Bersier (2007). Nestling barn owls beg more intensely in the presence of their mother than in the presence of their father. Animal Behaviour 74, 1099–1106.

Zuur, A. F., E. N. Ieno, N. J. Walker, A. A. Saveliev, and G. M. Smith (2009, March). Mixed Effects Models and Extensions in Ecology with R (1 ed.). Springer.
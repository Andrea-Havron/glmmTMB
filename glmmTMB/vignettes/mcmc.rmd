---
title: "post-hoc MCMC with glmmTMB"
author: "Ben Bolker"
date: "10/19/2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs,message=FALSE}
library(glmmTMB)
library(MCMCpack)
library(coda)
library(lattice)
library(ggplot2); theme_set(theme_bw())
library(reshape2)
```

Fit basic model:
```{r fit1}
data("sleepstudy",package="lme4")
fm1 <- glmmTMB(Reaction ~ Days + (Days|Subject),
               sleepstudy)
```

Set up for MCMC: extract
```{r mcmcsetup}
## FIXME: better way for user to extract full coefs?
rawcoef <- with(fm1$obj$env,last.par[-random])
## V <- vcov(fm1,full=TRUE)  ## doesn't work ...
stopifnot(all.equal(c(fm1$obj$fn(rawcoef)),
                    -c(logLik(fm1)),
          tolerance=1e-7))
## log-likelihood function 
## (MCMCmetrop1R wants *positive* log-lik)
fn <- function(x) -fm1$obj$fn(x)
```

```{r do_mcmc,cache=TRUE,results="hide"}
s1 <- system.time(m1 <- MCMCmetrop1R(fn,rawcoef))
```
(full run takes `r round(s1["elapsed"],1)` seconds)

Post-process for convenience:
```{r}
colnames(m1) <- c(names(fixef(fm1)[[1]]),
                        "log(sigma)",
                        paste0("theta",1:3))
```

```{r traceplot}
xyplot(m1,layout=c(2,3))
```

The trace plot for `theta3` is problematic; the effective sample size backs this up, as would any other diagnostics we did

```{r effsize}
print(effectiveSize(m1),digits=3)
```

Leaving out the intercept because it's on a very different scale (an alternative would be to facet to give each variable its own scale, but if we want violin plots + faceting + horizontal layout we would need to pull in the `ggstance` package ...)

```{r violins,echo=FALSE}
ggplot(melt(as.matrix(m1[,-1])),aes(x=Var2,y=value))+
         geom_violin(fill="gray")+coord_flip()
```

## To do

- diagnose and solve mixing for `theta3`
- better description/tools for end users to get at raw parameters and understand their meanings (especially variance-covariance parameters)
- more complex example - e.g. Owls
- multi-chain/Gelman-Rubin example? (Don't think `MCMCmetrop1R` can do this; could easily cook up a simple multivariate M-H sampler, but wouldn't want to reimplement all the bells and whistles, e.g. adaptive tuning ...)

